name: Deploy Spring Boot Backend to Oracle Cloud

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: OCI_PROD

    env:
      HOST: ${{ secrets.OCI_HOST }}
      USER: ${{ secrets.OCI_USER }}
      REPO_DIR: /home/ubuntu/korea-sky-planner-backend
      JAR_NAME: Board-0.0.1-SNAPSHOT.jar

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.OCI_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if [ -z "$HOST" ]; then
            echo "Error: HOST environment variable is not set"; exit 1;
          fi
          
          # í˜¸ìŠ¤íŠ¸ í‚¤ ìŠ¤ìº” ë° ë“±ë¡
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "Failed to add host to known_hosts"; exit 1;
          }

      - name: Update Source Code on OCI Server
        run: |
          # OCI ì„œë²„ ì ‘ì† ë° ì½”ë“œ ë™ê¸°í™”
          ssh $USER@$HOST << EOF
            set -e
            if [ ! -d $REPO_DIR ]; then
              echo "Repository not found. Cloning..."
              mkdir -p $REPO_DIR
              git clone https://github.com/LeRealdeer/korea-sky-planner-backend.git $REPO_DIR || {
                echo "Failed to clone repository"; exit 1;
              }
            else
              echo "Repository exists. Pulling latest changes..."
              cd $REPO_DIR
              git reset --hard HEAD
              git pull || {
                echo "Failed to pull latest changes"; exit 1;
              }
            fi
          EOF

      # âœ… ìƒˆë¡œ ì¶”ê°€: ë©”ëª¨ë¦¬ ìµœì í™”
      - name: Optimize Memory Before Build
        run: |
          ssh $USER@$HOST << EOF
            set -e
            echo "=== Cleaning up zombie processes ==="
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
            
            echo "=== Clearing cache memory ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            
            echo "=== Memory status before build ==="
            free -h
          EOF

      - name: Clean Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn clean" || { echo "Failed to clean Maven project"; exit 1; }

      # âœ… ìˆ˜ì •: Maven ë¹Œë“œì— ë©”ëª¨ë¦¬ ì œí•œ ì¶”ê°€
      - name: Build Maven Project
        run: |
          ssh $USER@$HOST << EOF
            cd $REPO_DIR
            # Maven ë©”ëª¨ë¦¬ ì œí•œ (512MB)
            export MAVEN_OPTS="-Xmx512m -Xms256m"
            mvn package -DskipTests || { 
              echo "Failed to build Maven project"; 
              exit 1; 
            }
          EOF

      # âœ… ìˆ˜ì •: Java ì‹¤í–‰ì— ë©”ëª¨ë¦¬ ì œí•œ ì¶”ê°€
      - name: Deploy Application & Verify Health
        run: |
          ssh $USER@$HOST << EOF
            set -e
            
            REPO_DIR="${REPO_DIR:-/home/ubuntu/korea-sky-planner-backend}"
            JAR_NAME="${JAR_NAME:-Board-0.0.1-SNAPSHOT.jar}"
            LOG_FILE="app.log"
            JAR_PATH="target/\$JAR_NAME"

            echo "Checking for existing application..."
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ PID í™•ì¸ ë° ì¢…ë£Œ
            if pid=\$(pgrep -f -u $USER \$JAR_NAME); then
              echo "Stopping existing application (PID: \$pid)..."
              sudo kill -15 \$pid 
              sleep 10 
              if pgrep -f -u $USER \$JAR_NAME; then
                  echo "Application not stopped, forcing kill..."
                  sudo kill -9 \$pid || true
              fi
            else
              echo "No running application found."
            fi
            
            # ë©”ëª¨ë¦¬ ì •ë¦¬ (ë°°í¬ ì§ì „)
            echo "=== Clearing memory before deployment ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            free -h

            echo "Starting new application..."
            cd \$REPO_DIR
            
            # âœ… Java ì‹¤í–‰ ì‹œ ë©”ëª¨ë¦¬ ì œí•œ ì¶”ê°€ (384MB)
            nohup java \
              -Xmx384m \
              -Xms256m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -jar \$JAR_PATH > \$LOG_FILE 2>&1 &
            
            echo "Waiting for application to start (Max 60s)..."
            START_SUCCESS=0
            MAX_CHECKS=12
            
            for i in \$(seq 1 \$MAX_CHECKS); do
              sleep 5
              if grep -q "Started" \$LOG_FILE; then
                echo "âœ… Application started successfully on check \$i."
                START_SUCCESS=1
                break
              fi
              echo "Check \$i/\$MAX_CHECKS: Not yet started..."
            done
            
            if [ \$START_SUCCESS -eq 0 ]; then
              echo "ğŸ”´ ERROR: Application failed to start within the timeout (60 seconds)."
              echo "Last 30 lines of log for debugging:"
              tail -n 30 \$LOG_FILE
              exit 1
            fi
            
            echo "=== Final memory status ==="
            free -h
            echo "Deployment successful and verified."
          EOF

      # âœ… ìƒˆë¡œ ì¶”ê°€: í•­ìƒ ì •ë¦¬
      - name: Cleanup (Always Run)
        if: always()
        run: |
          ssh $USER@$HOST << EOF
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
          EOF