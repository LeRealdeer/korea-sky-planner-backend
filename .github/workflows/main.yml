name: Deploy Spring Boot Backend to Oracle Cloud

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: OCI_PROD

    env:
      HOST: ${{ secrets.OCI_HOST }}
      USER: ${{ secrets.OCI_USER }}
      REPO_DIR: /home/ubuntu/korea-sky-planner-backend
      JAR_NAME: Board-0.0.1-SNAPSHOT.jar

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.OCI_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if [ -z "$HOST" ]; then
            echo "Error: HOST environment variable is not set"; exit 1;
          fi
          
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "Failed to add host to known_hosts"; exit 1;
          }

      - name: Update Source Code on OCI Server
        run: |
          ssh $USER@$HOST << EOF
            set -e
            if [ ! -d $REPO_DIR ]; then
              echo "Repository not found. Cloning..."
              mkdir -p $REPO_DIR
              git clone https://github.com/LeRealdeer/korea-sky-planner-backend.git $REPO_DIR || {
                echo "Failed to clone repository"; exit 1;
              }
            else
              echo "Repository exists. Pulling latest changes..."
              cd $REPO_DIR
              git reset --hard HEAD
              git pull || {
                echo "Failed to pull latest changes"; exit 1;
              }
            fi
          EOF

      - name: Clean Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn clean" || { echo "Failed to clean Maven project"; exit 1; }

      - name: Build Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn package -DskipTests" || { echo "Failed to build Maven project"; exit 1; }


      - name: Deploy Application
        run: |
          ssh $USER@$HOST << EOF
            set -e
            
            echo "Checking for existing application..."
            if pid=\$(pgrep -f -u $USER $JAR_NAME); then
              echo "Stopping existing application (PID: \$pid)..."
              sudo kill -15 \$pid 
              sleep 10 
              if pgrep -f -u $USER $JAR_NAME; then
                  sudo kill -9 \$pid || true
              fi
            else
              echo "No running application found."
            fi

            echo "Starting new application..."
            cd $REPO_DIR
            nohup java -jar target/Board-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
            
            echo "Waiting for application to start..."
            sleep 15
            
            echo "Recent application logs:"
            tail -n 10 app.log || {
              echo "Failed to read application logs"; exit 1;
            }
          EOF