name: Deploy Spring Boot Backend to Oracle Cloud

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: OCI_PROD

    env:
      HOST: ${{ secrets.OCI_HOST }}
      USER: ${{ secrets.OCI_USER }}
      REPO_DIR: /home/ubuntu/korea-sky-planner-backend
      JAR_NAME: Board-0.0.1-SNAPSHOT.jar

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.OCI_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if [ -z "$HOST" ]; then
            echo "Error: HOST environment variable is not set"; exit 1;
          fi
          
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "Failed to add host to known_hosts"; exit 1;
          }

      - name: Update Source Code on OCI Server
        run: |
          ssh $USER@$HOST << EOF
            set -e
            if [ ! -d $REPO_DIR ]; then
              echo "Repository not found. Cloning..."
              mkdir -p $REPO_DIR
              git clone https://github.com/LeRealdeer/korea-sky-planner-backend.git $REPO_DIR || {
                echo "Failed to clone repository"; exit 1;
              }
            else
              echo "Repository exists. Pulling latest changes..."
              cd $REPO_DIR
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi
          EOF

      - name: Optimize Memory Before Build
        run: |
          ssh $USER@$HOST << EOF
            set -e
            echo "=== Cleaning up zombie processes ==="
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
            
            echo "=== Clearing cache memory ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            
            echo "=== Memory status before build ==="
            free -h
          EOF

      - name: Clean Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn clean" || { echo "Failed to clean Maven project"; exit 1; }

      - name: Build Maven Project
        run: |
          ssh $USER@$HOST << EOF
            cd $REPO_DIR
            export MAVEN_OPTS="-Xmx768m -Xms384m"
            mvn package -DskipTests || { 
              echo "Failed to build Maven project"; 
              exit 1; 
            }
          EOF

      - name: Deploy Application
        run: |
          ssh $USER@$HOST << 'EOF'
            set -e
            
            REPO_DIR="/home/ubuntu/korea-sky-planner-backend"
            JAR_NAME="Board-0.0.1-SNAPSHOT.jar"
            LOG_FILE="app.log"
            JAR_PATH="target/$JAR_NAME"

            echo "=== Stopping existing application ==="
            if pid=$(pgrep -f "$JAR_NAME"); then
              echo "Found existing application (PID: $pid)"
              sudo kill -15 $pid 
              sleep 10 
              if pgrep -f "$JAR_NAME"; then
                  echo "Forcing kill..."
                  sudo kill -9 $pid || true
              fi
              echo "Stopped."
            else
              echo "No running application found."
            fi
            
            echo "=== Clearing memory ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            free -h

            echo "=== Starting new application ==="
            cd $REPO_DIR
            
            # ë¡œê·¸ íŒŒì¼ ë°±ì—…
            [ -f $LOG_FILE ] && mv $LOG_FILE "${LOG_FILE}.old"
            
            # .env íŒŒì¼ ë¡œë“œí•˜ê³  ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹œìž‘ (ë©”ëª¨ë¦¬ 512MBë¡œ ì¦ê°€)
            export $(cat .env | grep -v '^#' | xargs) && \
            nohup java \
              -Xmx512m \
              -Xms256m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -jar $JAR_PATH > $LOG_FILE 2>&1 &
            
            NEW_PID=$!
            echo "âœ… Application started with PID: $NEW_PID"
            echo ""
            echo "Logs will be written to: $REPO_DIR/$LOG_FILE"
            echo "Monitor with: tail -f $REPO_DIR/$LOG_FILE"
            echo ""
            
            # 10ì´ˆë§Œ ê¸°ë‹¤ë ¤ì„œ ì¦‰ì‹œ í¬ëž˜ì‹œëŠ” ê°ì§€
            sleep 10
            
            if ! kill -0 $NEW_PID 2>/dev/null; then
              echo "ðŸ”´ ERROR: Application crashed immediately!"
              echo "Last 50 lines of log:"
              tail -n 50 $LOG_FILE
              exit 1
            fi
            
            echo "âœ… Application is running (PID: $NEW_PID)"
            echo "First 20 lines of log:"
            head -n 20 $LOG_FILE
            echo ""
            echo "=== Deployment completed ==="
            echo "Application will continue starting in background."
            echo "Check status: ps aux | grep $JAR_NAME"
          EOF

      - name: Cleanup (Always Run)
        if: always()
        run: |
          ssh $USER@$HOST << 'EOF'
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
          EOF