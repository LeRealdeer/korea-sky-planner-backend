name: Deploy Spring Boot Backend to Oracle Cloud

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest 

    environment: OCI_PROD # ğŸŒŸ í™˜ê²½ ì´ë¦„ ë³€ê²½

    env:
      HOST: ${{ secrets.OCI_HOST }}
      USER: ${{ secrets.OCI_USER }}
      REPO_DIR: /home/ubuntu/korea-sky-planner-backend # ğŸŒŸ í”„ë¡œì íŠ¸ ê²½ë¡œ ì •ì˜
      JAR_NAME: Board-0.0.1-SNAPSHOT.jar # ğŸŒŸ ì‹¤í–‰í•  JAR íŒŒì¼ ì´ë¦„ ì •ì˜

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # 1. SSH í‚¤ ì„¤ì •
      # ----------------------------------------------------------------------
      - name: Configure SSH Key
        env:
          # ğŸŒŸ ë¹„ë°€ ì •ë³´ ì´ë¦„ ë³€ê²½ (EC2 -> OCI)
          SSH_PRIVATE_KEY: ${{ secrets.OCI_KEY }} 
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if [ -z "$HOST" ]; then
            echo "Error: HOST environment variable is not set"; exit 1;
          fi
          
          # HOST í‚¤ë¥¼ known_hostsì— ì¶”ê°€ (SSH ì—°ê²° ì‹œ í•„ìˆ˜)
          echo "Adding host to known_hosts"
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "Failed to add host to known_hosts"; exit 1;
          }

      # ----------------------------------------------------------------------
      # 2. ì„œë²„ì— í”„ë¡œì íŠ¸ ë³µì œ/ì—…ë°ì´íŠ¸
      # ----------------------------------------------------------------------
      - name: Update Source Code on OCI Server
        run: |
          ssh $USER@$HOST << EOF
            set -e
            
            # ğŸŒŸ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ë³µì œ, ìˆìœ¼ë©´ í’€(Pull)
            if [ ! -d $REPO_DIR ]; then
              echo "Repository not found. Creating directory and cloning..."
              mkdir -p $REPO_DIR
              git clone https://github.com/LeRealdeer/korea-sky-planner-backend.git $REPO_DIR || {
                echo "Failed to clone repository"; exit 1;
              }
            else
              echo "Repository exists. Pulling latest changes..."
              cd $REPO_DIR
              # ë³€ê²½ ì‚¬í•­ì´ ì—†ì„ ë•Œ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ git reset --hard ì¶”ê°€
              git reset --hard HEAD
              git pull || {
                echo "Failed to pull latest changes"; exit 1;
              }
            fi
          EOF
      - name: Clean Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn clean" || { echo "Failed to clean Maven project"; exit 1; }

      - name: Build Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn package -DskipTests" || { echo "Failed to build Maven project"; exit 1; }
      
      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì€ ê°œë°œ í•„ìš”ì„±ì— ë”°ë¼ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      - name: Run Tests
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn test" || { echo "Tests failed"; exit 1; }

      # ----------------------------------------------------------------------
      # 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° ì‹œì‘
      # ----------------------------------------------------------------------
      - name: Deploy Application
        run: |
          ssh $USER@$HOST << EOF
            set -e
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
            echo "Checking for existing application..."
            # ğŸŒŸ JAR_NAME ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ ì°¾ê¸°
            if pid=\$(pgrep -f "\$JAR_NAME"); then
              echo "Stopping existing application (PID: \$pid)..."
              # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì€ kill -15 (SIGTERM)ìœ¼ë¡œ ì¢…ë£Œí•˜ëŠ” ê²ƒì´ ë” ì•ˆì „
              kill -15 \$pid 
              # killì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ CI/CDê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ || true ì¶”ê°€
              sleep 10 
              # 10ì´ˆ í›„ì—ë„ ì¢…ë£Œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê°•ì œ ì¢…ë£Œ
              if pgrep -f "\$JAR_NAME"; then
                  kill -9 \$pid || true
              fi
            else
              echo "No running application found."
            fi

            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            echo "Starting new application..."
            cd $REPO_DIR
            # nohupìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ì„¸ì…˜ì´ ëŠê²¨ë„ ìœ ì§€ë˜ë„ë¡ í•¨
            nohup java -jar target/\$JAR_NAME > app.log 2>&1 &
            
            # í”„ë¡œì„¸ìŠ¤ ì‹œì‘ í™•ì¸
            echo "Waiting for application to start..."
            sleep 15 # Spring BootëŠ” ì‹œì‘ ì‹œê°„ì´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 15ì´ˆ ëŒ€ê¸°
            
            # ë¡œê·¸ í™•ì¸ (ë§ˆì§€ë§‰ 10ì¤„ë§Œ)
            echo "Recent application logs:"
            tail -n 10 app.log || {
              echo "Failed to read application logs"; exit 1;
            }
          EOF
