name: Deploy Spring Boot Backend to Oracle Cloud

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: OCI_PROD

    env:
      HOST: ${{ secrets.OCI_HOST }}
      USER: ${{ secrets.OCI_USER }}
      REPO_DIR: /home/ubuntu/korea-sky-planner-backend
      JAR_NAME: Board-0.0.1-SNAPSHOT.jar

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.OCI_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if [ -z "$HOST" ]; then
            echo "Error: HOST environment variable is not set"; exit 1;
          fi
          
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "Failed to add host to known_hosts"; exit 1;
          }

      - name: Update Source Code on OCI Server
        run: |
          ssh $USER@$HOST << EOF
            set -e
            if [ ! -d $REPO_DIR ]; then
              echo "Repository not found. Cloning..."
              mkdir -p $REPO_DIR
              git clone https://github.com/LeRealdeer/korea-sky-planner-backend.git $REPO_DIR || {
                echo "Failed to clone repository"; exit 1;
              }
            else
              echo "Repository exists. Pulling latest changes..."
              cd $REPO_DIR
              git reset --hard HEAD
              git pull || {
                echo "Failed to pull latest changes"; exit 1;
              }
            fi
          EOF

      - name: Optimize Memory Before Build
        run: |
          ssh $USER@$HOST << EOF
            set -e
            echo "=== Cleaning up zombie processes ==="
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
            
            echo "=== Clearing cache memory ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            
            echo "=== Memory status before build ==="
            free -h
          EOF

      - name: Clean Maven Project
        run: ssh $USER@$HOST "cd $REPO_DIR && mvn clean" || { echo "Failed to clean Maven project"; exit 1; }

      - name: Build Maven Project
        run: |
          ssh $USER@$HOST << EOF
            cd $REPO_DIR
            export MAVEN_OPTS="-Xmx512m -Xms256m"
            mvn package -DskipTests || { 
              echo "Failed to build Maven project"; 
              exit 1; 
            }
          EOF

      - name: Deploy Application & Verify Health
        run: |
          ssh $USER@$HOST << 'EOF'
            set -e
            
            REPO_DIR="/home/ubuntu/korea-sky-planner-backend"
            JAR_NAME="Board-0.0.1-SNAPSHOT.jar"
            LOG_FILE="app.log"
            JAR_PATH="target/$JAR_NAME"

            echo "Checking for existing application..."
            
            if pid=$(pgrep -f "$JAR_NAME"); then
              echo "Stopping existing application (PID: $pid)..."
              sudo kill -15 $pid 
              sleep 10 
              if pgrep -f "$JAR_NAME"; then
                  echo "Application not stopped, forcing kill..."
                  sudo kill -9 $pid || true
              fi
            else
              echo "No running application found."
            fi
            
            echo "=== Clearing memory before deployment ==="
            sudo sync
            sudo sysctl -w vm.drop_caches=3
            free -h

            echo "Starting new application..."
            cd $REPO_DIR
            
            # Î°úÍ∑∏ ÌååÏùº Î∞±ÏóÖ
            if [ -f $LOG_FILE ]; then
              mv $LOG_FILE "${LOG_FILE}.old"
            fi
            
            nohup java \
              -Xmx384m \
              -Xms256m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -jar $JAR_PATH > $LOG_FILE 2>&1 &
            
            NEW_PID=$!
            echo "Started application with PID: $NEW_PID"
            
            echo "Waiting for application to start (Max 120s)..."
            START_SUCCESS=0
            MAX_CHECKS=24  # 5Ï¥à * 24 = 120Ï¥à
            
            for i in $(seq 1 $MAX_CHECKS); do
              sleep 5
              
              # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ï£ΩÏóàÎäîÏßÄ ÌôïÏù∏
              if ! kill -0 $NEW_PID 2>/dev/null; then
                echo "üî¥ ERROR: Application process died!"
                echo "Last 50 lines of log:"
                tail -n 50 $LOG_FILE
                exit 1
              fi
              
              # ÏãúÏûë ÏôÑÎ£å ÌôïÏù∏
              if grep -q "Started BoardApplication" $LOG_FILE; then
                echo "‚úÖ Application started successfully on check $i (${i}0 seconds)."
                START_SUCCESS=1
                break
              fi
              
              # ÏßÑÌñâ ÏÉÅÌô© Ï∂úÎ†•
              echo "Check $i/$MAX_CHECKS (${i}0s): Still starting..."
              tail -n 3 $LOG_FILE | grep -v "^$"
            done
            
            if [ $START_SUCCESS -eq 0 ]; then
              echo "üî¥ ERROR: Application failed to start within 120 seconds."
              echo ""
              echo "=== Full log ==="
              cat $LOG_FILE
              exit 1
            fi
            
            echo ""
            echo "=== Final memory status ==="
            free -h
            echo ""
            echo "=== Application info ==="
            echo "PID: $NEW_PID"
            ps aux | grep $JAR_NAME | grep -v grep
            echo ""
            echo "‚úÖ Deployment successful and verified."
          EOF

      - name: Cleanup (Always Run)
        if: always()
        run: |
          ssh $USER@$HOST << 'EOF'
            sudo pkill -9 runnv 2>/dev/null || true
            sudo rm -rf /tmp/runnv 2>/dev/null || true
          EOF